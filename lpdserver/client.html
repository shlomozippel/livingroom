<!DOCTYPE html>
<html>
<head>
</head>
<body>

<script type="text/javascript">

//-----------------------------------------------------------------------------
// shims

window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
})();

/*
// hack to lower framerate
window.requestAnimFrame = function( callback ){
            window.setTimeout(callback, 1000 / 10);
          }
*/

window.WebSocket = window.WebSocket || window.MozWebSocket;

if (window.performance.now) {
    console.log("Using high performance timer");
    getTimestamp = function() { return window.performance.now(); };
} else {
    if (window.performance.webkitNow) {
        console.log("Using webkit high performance timer");
        getTimestamp = function() { return window.performance.webkitNow(); };
    } else {
        console.log("Using low performance timer");
        getTimestamp = function() { return new Date().getTime(); };
    }
}

Math.fmod = function (a,b) { return Number((a - (Math.floor(a / b) * b)).toPrecision(8)); };

//-----------------------------------------------------------------------------

console.log("Connecting...")
var ws = new WebSocket('ws://192.168.1.123:9000', 'leds');
ws.binaryType = "arraybuffer";

//-----------------------------------------------------------------------------
// led stuff

var led_count = 810;
var byte_count = led_count * 3;
var leds = new Uint8ClampedArray(byte_count);

/* accepts parameters
 * h  Object = {h:x, s:y, v:z}
 * OR 
 * h, s, v
*/
/**
 * Converts an HSV color value to RGB. Conversion formula
 * adapted from http://en.wikipedia.org/wiki/HSV_color_space.
 * Assumes h, s, and v are contained in the set [0, 1] and
 * returns r, g, and b in the set [0, 255].
 *
 * @param   Number  h       The hue
 * @param   Number  s       The saturation
 * @param   Number  v       The value
 * @return  Array           The RGB representation
 */
function hsvToRgb(h, s, v) {
  var r, g, b;
 
  var i = Math.floor(h * 6);
  var f = h * 6 - i;
  var p = v * (1 - s);
  var q = v * (1 - f * s);
  var t = v * (1 - (1 - f) * s);
 
  switch (i % 6) {
    case 0: r = v, g = t, b = p; break;
    case 1: r = q, g = v, b = p; break;
    case 2: r = p, g = v, b = t; break;
    case 3: r = p, g = q, b = v; break;
    case 4: r = t, g = p, b = v; break;
    case 5: r = v, g = p, b = q; break;
  }
 
  return { r:r * 255, g:g * 255, b:b * 255 };
}

function lerp(a,b,u) {
    return (1-u) * a + u * b;
};

function lerpColor(c1, c2, u) {
    return {
        r: lerp(c1.r, c2.r, u),
        g: lerp(c1.g, c2.g, u),
        b: lerp(c1.b, c2.b, u),
    }
}

function setColor(r, g, b) {
    if (r && g === undefined && b === undefined) {
        r = r.r, g = r.g, b = r.b;
    }

    for (var i=0;i<this.byte_count;i+=3) {
        this.leds[i] = r;
        this.leds[i+1] = g;
        this.leds[i+2] = b;
    }
}

function clear() {
    setColor(0, 0, 0);
}


//-----------------------------------------------------------------------------
// render loop

var start_time = 0;
var last_time = 0;

var frames = 0;

ws.onopen = function() {
    console.log("Websocket connected")
    start_time = getTimestamp();
    last_time = start_time;
}

var c1 = {
    r : 255,
    g : 0,
    b : 0
}

var c2 = {
    r : 0,
    g : 255,
    b : 128
}

var h = 0.0;
var step = 1.0 / (10.0 * 60.0); // 10 seconds

function render(t, dt) {
    // hsv
    var c = hsvToRgb(Math.fmod(h, 1.0), 1.0, 1.0);
    h += step;

    // rgb lerp
    //var c = lerpColor(c1, c2, Math.fmod(getTimestamp()/20000.0, 1.0));
    
    // solid color
    //var c = {r:255, g:0, b: 0};
    
    setColor(c.r, c.g, c.b);
}

(function animloop(){
    if (ws.readyState == WebSocket.OPEN) {
        var curr_time = getTimestamp();
        render(curr_time - start_time, curr_time - last_time);
        last_time = curr_time;
        ws.send(leds);
        frames++;
    }
    requestAnimFrame(animloop);
})();
        
</script>
</body>
</html>